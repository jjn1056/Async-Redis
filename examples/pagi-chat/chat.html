<!DOCTYPE html>
<html>
<head>
    <title>PAGI + Future::IO::Redis Chat</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        #input { width: calc(100% - 80px); padding: 10px; }
        button { width: 70px; padding: 10px; }
        .system { color: #666; font-style: italic; }
        .message { margin: 5px 0; }
        #status { padding: 5px; margin-bottom: 10px; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Multi-Worker Chat Demo</h1>
    <p>This chat uses Redis PubSub to sync messages across multiple PAGI workers.</p>

    <div id="status" class="disconnected">Disconnected</div>
    <div id="messages"></div>
    <div>
        <input type="text" id="input" placeholder="Type a message..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()">Send</button>
    </div>

    <script>
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const status = document.getElementById('status');
        let ws;

        function connect() {
            ws = new WebSocket(`ws://${location.host}/`);

            ws.onopen = () => {
                status.textContent = 'Connected';
                status.className = 'connected';
            };

            ws.onclose = () => {
                status.textContent = 'Disconnected - Reconnecting...';
                status.className = 'disconnected';
                setTimeout(connect, 2000);
            };

            ws.onmessage = (e) => {
                const div = document.createElement('div');
                div.className = e.data.startsWith('***') ? 'system message' : 'message';
                div.textContent = e.data;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            };
        }

        function send() {
            if (ws && ws.readyState === WebSocket.OPEN && input.value.trim()) {
                ws.send(input.value);
                input.value = '';
            }
        }

        connect();
    </script>
</body>
</html>
